#!/usr/bin/env node

const { program } = require('commander');
const chalk = require('chalk');
const inquirer = require('inquirer');
const gitBranchIs = require('git-branch-is');
const { command, isLocalChanged, resolve, exists, mkdir, touch, stringFormat, stat, isRemoteRegistry, readFile, writeFile, oraPromise, jsonFormat, rm } = require('../lib/utils.js');
const SETTINGS_CONFIG = require('../.vscode/settings.json')


program
  .usage('<plugin-name>')

program.on('--help', () => {
  console.log('  Examples:')
  console.log()
  console.log(chalk.gray('    # install rich\'s plugin'))
  console.log('    $ rich install eslint')
  console.log()
})

function help() {
  program.parse(process.argv)
  if (program.args.length < 1) return program.help()
}
help()

const INSTALL_PLUGIN_NAME = program.args[0]; // å®‰è£…çš„æ’ä»¶åç§°ï¼Œä¾‹å¦‚: eslint

process.on('exit', () => {
  console.log()
})

class Package {
  constructor () {
    this.packageJson = {};
    this.dependencies = {};
    this.devDependencies = {};
  }

  async readPackageJson () {
    const jsonStr = await readFile('package.json')
    this.packageJson = JSON.parse(jsonStr) || {}
    this.dependencies = this.packageJson['dependencies'] || {}
    this.devDependencies = this.packageJson['devDependencies'] || {}
  }

  updatePackageJson () {
    return this.readPackageJson()
  }

  writePackageJson (newPackageJson) {
    this.packageJson = newPackageJson
    return writeFile('package.json', jsonFormat(newPackageJson))
  }

  /**
   * @description é€šè¿‡ä¾èµ–åç§°è·å–ç‰ˆæœ¬
   */
  getDependencyVersion  (dependencyName) {
    const { dependencies = {} } = this
    return dependencies?.[dependencyName]
  }

 /**
  * @description è·å– vue ç‰ˆæœ¬
  * @returns 
  */
  getVueVersion () {
    const version = this.getDependencyVersion('vue');
    return version ? version.match(/\d/)[0] : null
  }

  /**
   * @description è·å–æ‰€æœ‰ä¾èµ–
   * @returns 
  */
  getAllDependencies () {
    const { devDependencies, dependencies } = this
    return Object.assign({}, devDependencies, dependencies)
  }


  async removeConfig () {
    await this.readPackageJson()
    const { packageJson } = this
    if (packageJson['eslintConfig'] || packageJson['prettier']) {
      // åˆ é™¤package.jsonä¸­çš„eslintConfig
      packageJson['eslintConfig'] && delete packageJson['eslintConfig']
      // åˆ é™¤package.jsonä¸­çš„prettier
      packageJson['prettier'] && delete packageJson['prettier']
      return this.writePackageJson(packageJson)
    }
    return Promise.resolve()
  }

  /**
   * @description æ ¹æ®pluginså»package.jsonåˆ¤æ–­ä¾èµ–æ˜¯å¦å®‰è£…è¿‡
   * @param { Array | string } plugins ä¾èµ–åå­—æˆ–å¤šä¸ªä¾èµ–
   * @returns {"eslint": true| false}
   */
  isInstalled (plugins) {
    const pluginNameReg = new RegExp(`"${INSTALL_PLUGIN_NAME}"`)
    return Array.isArray(plugins)
      ? plugins.reduce((obj, plugin) => {
        return Object.assign(obj, {
          [plugin]: pluginNameReg.test(this.packageJson)
        })
      }, {})
      : { [plugins]: pluginNameReg.test(this.packageJson)}
  }
}


class FileOperator {
  constructor () {
    this.deleteFiles = ['.eslintrc.json', '.eslintrc.yaml', '.eslintrc.js', '.prettierrc.js','.prettierignore']
  }
  /**
 * @description æ˜¯å¦åˆå§‹åŒ–äº† git
 * @returns Promise<Boolean>
 */
  isInitGit () {
    return stat('.git')
  }
  /**
 * @description æ˜¯å¦åˆå§‹åŒ–äº† npm
 * @returns Promise<Boolean>
 */
  isInitNpm () {
    return stat('package.json')
  }
  /**
   * @description æ˜¯å¦æœ‰.gitignoreæ–‡ä»¶
   * @returns 
   */
  hasGitignore () {
    return stat('.gitignore')
  }
  /**
   * @description åˆ›å»º.gitignore æ–‡ä»¶
   * @param ignoreRegs 
   */
  createGitIgnore = (ignoreRegs) => {
    touch('.gitignore', stringFormat(ignoreRegs))
  }

  /**
   * @description è·å– eslint é…ç½®æ¨¡æ¿å¯¹è±¡
   * @returns 
  */
  getESLintConfig (vueVersion) {
    const base = {
      extends: [
        "eslint:recommended",
      ],
      rules: {}
    }
    if (vueVersion) {
      base.extends.push(Number(vueVersion) === 2 ? 'plugin:vue/recommended' : "plugin:vue/vue3-recommended")
    }
    base.extends.push("eslint-config-rich")
    return base;
  }


  /**
   * @description å†™å…¥vscode é…ç½®
  */
  writeVsCodeConfig () {
    return oraPromise(() => {
      if (!exists('.vscode')) mkdir('.vscode');
      return writeFile('.vscode/settings.json', stringFormat(SETTINGS_CONFIG))
    }, {text: 'é…ç½®vscode'})
  }

  /**
   * @description å†™å…¥é…ç½®åˆ°é…ç½®æ–‡ä»¶
   * @param { object } newObj å†™å…¥æ–‡ä»¶çš„å¯¹è±¡
   * @param { string } path é…ç½®æ–‡ä»¶è·¯å¾„
   */
  writeConfigToFile  (newObj, path) {
    const content = jsonFormat(newObj)
    writeFile(path, content)
  }

  /**
   * @description åˆ é™¤ESLintå…¶ä½™çš„é…ç½®æ–‡ä»¶å’Œprettieré…ç½®
   * ä¾‹å¦‚ï¼š
   * package.jsonä¸­çš„eslintConfigå­—æ®µ
   * .eslintrc.json
   * .eslintrc
   * .eslintrc.yaml
   */
  writeESLintConfig (vueVersion) {
    const { deleteFiles } = this
    oraPromise(() => {
      // å¹¶å‘åˆ é™¤é…ç½®æ–‡ä»¶
      let promises = deleteFiles.reduce((promises, filePath) => promises.concat(rm(filePath)), [])
      const eslintConfig = this.getESLintConfig(vueVersion)
      // å†™å…¥eslinté…ç½®
      promises.push(this.writeConfigToFile(eslintConfig, resolve('.eslintrc')))
      return Promise.all(promises).catch(()=>{})
    }, { text: 'é…ç½®ESLint' })
  }
}

class CommandOperator {
  constructor () {
    this.packageCommand = {};
    this.packageConfig = {
      'npm': {
        command: 'npm',
        install: "npm install",
        uninstall: 'npm uninstall',
        suffix: '-D'
      },
      'yarn': {
        command: 'yarn',
        install: "yarn add",
        uninstall: 'yarn remove',
        suffix: '--dev'
      }
    }
  }

  async init () {
    let answer = await inquirer.prompt([{
      name: 'packtool',
      type: 'list',
      message: 'è¯·é€‰æ‹©åŒ…ç®¡ç†å™¨',
      choices: ['npm', 'yarn', 'pnpm'],
      default: 0
    }])
    this.packageCommand = this.packageConfig[answer.packtool]
  }
  /**
   * @description å®‰è£…ä¾èµ–
   * @param { string } packtool åŒ…ç®¡ç†å·¥å…·
   * @param { Array } plugins éœ€è¦å®‰è£…çš„ä¾èµ–
   */
  installPlugins (plugins) {
    const { packageCommand } = this
    return plugins.length
      ? command(`${packageCommand.install} ${plugins.join(' ')} ${packageCommand.suffix}`)
      : Promise.resolve()
  }

  /**
   * @description å¸è½½ä¾èµ–
   * @param plugins 
   */
  uninstallPlugins (plugins) {
    return plugins.length 
      ? command(`${this.packageCommand.uninstall} ${plugins.join(' ')}`) 
      : Promise.resolve()
  }

  /**
   * @description ä½¿ç”¨eslintæ ¼å¼åŒ–ä»£ç 
   */
  formatCodeByEslint () {
    return oraPromise(() => command('npx eslint --fix --ext .js,.vue,.ts .'), {text: 'æ ¼å¼åŒ–ä»£ç '})
      .catch(() => {
        console.log(chalk.red('ESLintè¯­æ³•é”™è¯¯æ— æ³•è‡ªåŠ¨ä¿®å¤ï¼Œè¯·æ‰‹åŠ¨ä¿®å¤æˆ–åœ¨.eslintrc.jsä¸­å¿½ç•¥è§„åˆ™'))
        console.log(chalk.green('ä¿®å¤åè¯·ç»§ç»­æ‰§è¡Œ `rich lint` è¿›è¡Œæ ¡éªŒ'))
        process.exit()
      })
  }

  async commit (msg) {
    // åšä¸€æ¬¡ git æäº¤
    await command('git add .')
    await command(`git commit -m "${msg}"`)
  }
}


const main = async () => {
  const packageIns = new Package()
  const fileIns = new FileOperator()

  await packageIns.readPackageJson()
  const commandIns = new CommandOperator(fileIns.packageJson)
  await commandIns.init()
  const installPlugins = ['eslint-config-rich', 'eslint', 'eslint-plugin-vue']
  const prettierPlugins = Object.keys(packageIns.devDependencies).filter(t => /prettier|eslint/.test(t))
  const vueVersion = packageIns.getVueVersion()

  // 1ã€æ£€æŸ¥æ˜¯å¦åˆå§‹åŒ–è¿‡npm
  // 2ã€æ˜¯å¦æœ‰.gitignoreæ–‡ä»¶
  await Promise.all([
    fileIns.isInitNpm(),
    fileIns.hasGitignore()
  ])
  .then(([r1, r2]) => {
    r1 || command(`npm init -y`)
    r2 || fileIns.createGitIgnore(['node_modules', '.DS_Store', 'dist'])
  })


  // 1ã€æ˜¯å¦åˆå§‹åŒ–è¿‡git
  // 2ã€æ˜¯å¦æœ‰æœ¬åœ°ä¿®æ”¹
  await Promise.all([fileIns.isInitGit(), isLocalChanged()])
    .then(async ([r1, r2]) => {
      if (!r1) {
        command('git init')
        command('git add .')
        command('git commit -m "feat: first commit"')
      }
      if (r2) {
        console.log(chalk.red('æœ¬åœ°æœ‰ä¿®æ”¹ä½†æœªæäº¤çš„æ–‡ä»¶, å·²ä¸ºä½ è¿›è¡Œæœ¬åœ°æš‚å­˜'))
        await oraPromise(() => command('git stash push'), {text: 'æš‚å­˜ä»£ç '}) 
      }
    })

  // åˆ‡æ¢åˆ°masteråˆ†æ”¯
  if (!await gitBranchIs('master')) {
    await oraPromise(() => command('git checkout master'), {text: 'åˆ‡æ¢master'})
  }

  // å¦‚æœæ˜¯è¿œç¨‹ä»“åº“ï¼Œæ‹‰å–æ›´æ–°
  if (await isRemoteRegistry()) {
    await oraPromise(() => command('git pull'), {text: 'æ‹‰å–æ›´æ–°'})
  }

  await oraPromise(async () => {
    await commandIns.uninstallPlugins(prettierPlugins)
    await commandIns.installPlugins(installPlugins)
    await packageIns.removeConfig()
  }, {text: 'é…ç½®ä¾èµ–'})
  

  await Promise.all([
    fileIns.writeESLintConfig(vueVersion),
    fileIns.writeVsCodeConfig()
  ])

  // æ ¼å¼åŒ–ä»£ç 
  await commandIns.formatCodeByEslint()
  
  await commandIns.commit('ci: install eslint and format')
  console.log(chalk.green('ğŸ‰å®‰è£…æˆåŠŸ, è¯·åˆ°masteråˆ†æ”¯æŸ¥çœ‹æœ€æ–°ä¸€æ¬¡çš„ä¿®æ”¹'))
}

main()









